{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Config",
  "description": "A Configuration structure",
  "type": "object",
  "required": [
    "datasource",
    "environments",
    "flag_metrics",
    "health_metrics",
    "server"
  ],
  "properties": {
    "datasource": {
      "description": "Datasource link",
      "allOf": [
        {
          "$ref": "#/definitions/Datasource"
        }
      ]
    },
    "environments": {
      "description": "Environments",
      "type": "array",
      "items": {
        "$ref": "#/definitions/EnvironmentDef"
      }
    },
    "flag_metrics": {
      "description": "Flag metrics",
      "type": "array",
      "items": {
        "$ref": "#/definitions/FlagMetricDef"
      }
    },
    "health_metrics": {
      "description": "Health metrics",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/ServiceHealthDef"
      }
    },
    "health_query": {
      "description": "Health metrics query configuration",
      "allOf": [
        {
          "$ref": "#/definitions/HealthQueryConfig"
        }
      ]
    },
    "metric_templates": {
      "description": "Metric templates",
      "type": [
        "object",
        "null"
      ],
      "additionalProperties": {
        "$ref": "#/definitions/BinaryMetricRawDef"
      }
    },
    "server": {
      "description": "Server API binding",
      "allOf": [
        {
          "$ref": "#/definitions/ServerConf"
        }
      ]
    },
    "status_dashboard": {
      "description": "Status Dashboard connection",
      "anyOf": [
        {
          "$ref": "#/definitions/StatusDashboardConfig"
        },
        {
          "type": "null"
        }
      ]
    }
  },
  "definitions": {
    "BinaryMetricRawDef": {
      "type": "object",
      "required": [
        "op",
        "query",
        "threshold"
      ],
      "properties": {
        "op": {
          "$ref": "#/definitions/CmpType"
        },
        "query": {
          "type": "string"
        },
        "threshold": {
          "type": "number",
          "format": "float"
        }
      }
    },
    "CmpType": {
      "type": "string",
      "enum": [
        "lt",
        "gt",
        "eq"
      ]
    },
    "Datasource": {
      "description": "TSDB Datasource connection",
      "type": "object",
      "required": [
        "url"
      ],
      "properties": {
        "timeout": {
          "description": "query timeout",
          "default": 10,
          "type": "integer",
          "format": "uint16",
          "minimum": 0.0
        },
        "url": {
          "description": "TSDB url",
          "type": "string"
        }
      }
    },
    "EnvironmentDef": {
      "type": "object",
      "required": [
        "name"
      ],
      "properties": {
        "attributes": {
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "type": "string"
          }
        },
        "name": {
          "type": "string"
        }
      }
    },
    "FlagMetricDef": {
      "type": "object",
      "required": [
        "environments",
        "name",
        "service"
      ],
      "properties": {
        "environments": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/MetricEnvironmentDef"
          }
        },
        "name": {
          "type": "string"
        },
        "service": {
          "type": "string"
        },
        "template": {
          "anyOf": [
            {
              "$ref": "#/definitions/MetricTemplateRef"
            },
            {
              "type": "null"
            }
          ]
        }
      }
    },
    "HealthQueryConfig": {
      "description": "Health metrics query configuration",
      "type": "object",
      "properties": {
        "query_from": {
          "description": "Query start time offset for health metrics (e.g., \"-5min\")",
          "default": "-5min",
          "type": "string"
        },
        "query_to": {
          "description": "Query end time offset for health metrics (e.g., \"-2min\")",
          "default": "-2min",
          "type": "string"
        }
      }
    },
    "MetricEnvironmentDef": {
      "type": "object",
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "threshold": {
          "type": [
            "number",
            "null"
          ],
          "format": "float"
        }
      }
    },
    "MetricExpressionDef": {
      "type": "object",
      "required": [
        "expression",
        "weight"
      ],
      "properties": {
        "expression": {
          "type": "string"
        },
        "weight": {
          "type": "integer",
          "format": "int32"
        }
      }
    },
    "MetricTemplateRef": {
      "type": "object",
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "vars": {
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "ServerConf": {
      "description": "Server binding configuration",
      "type": "object",
      "properties": {
        "address": {
          "description": "IP address to bind to",
          "default": "0.0.0.0",
          "type": "string"
        },
        "port": {
          "description": "Port to bind to",
          "default": 3000,
          "type": "integer",
          "format": "uint16",
          "minimum": 0.0
        }
      }
    },
    "ServiceHealthDef": {
      "type": "object",
      "required": [
        "category",
        "expressions",
        "metrics",
        "service"
      ],
      "properties": {
        "category": {
          "type": "string"
        },
        "component_name": {
          "type": [
            "string",
            "null"
          ]
        },
        "expressions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/MetricExpressionDef"
          }
        },
        "metrics": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "service": {
          "type": "string"
        }
      }
    },
    "StatusDashboardConfig": {
      "description": "Status Dashboard configuration",
      "type": "object",
      "required": [
        "url"
      ],
      "properties": {
        "secret": {
          "description": "JWT token signature secret",
          "type": [
            "string",
            "null"
          ]
        },
        "url": {
          "description": "Status dashboard URL",
          "type": "string"
        }
      }
    }
  }
}